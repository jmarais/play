<!--  

Copyright 2015 Walter Schulze

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License. 

-->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Katydid Playground</title>
  <link rel="stylesheet" href="https://cdn.rawgit.com/tlvince/bootstrap-theme-cosmo/master/cosmo.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script src="https://rawgit.com/michael/github/master/github.js"></script>
  <script src="https://cdn.rawgit.com/codemirror/CodeMirror/master/lib/codemirror.js"></script>
  <link rel="stylesheet" href="https://cdn.rawgit.com/codemirror/CodeMirror/master/lib/codemirror.css">
  <script src="https://cdn.rawgit.com/codemirror/CodeMirror/master/mode/javascript/javascript.js"></script>
  <script src="http://codemirror.net/addon/mode/simple.js"></script>
  <script src="main.js"></script>

  <script>

function getUrlParameter(sParam) {
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++) 
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) 
        {
            return sParameterName[1];
        }
    }
}

function validate() {
	validateCode(katydidCodeMirror, jsonCodeMirror);
}

function validateCode(katydidCodeMirror, jsonCodeMirror) {
	$('#theoutput').prop("class", "alert alert-info");
	$('#theoutput').text("compiling...");
	var katydidcode = katydidCodeMirror.getValue();
	var jsoncode = jsonCodeMirror.getValue();
	var validateFunc = gofunctions["Validate"];
	var res = validateFunc(katydidcode, jsoncode);
	if (res.indexOf("Error: ") === 0) {
		res = res.replace("Error: ", "");
		$('#theoutput').prop("class", "alert alert-danger");
		$('#theoutput').text(res);
	} else {
		if (res == "true") {
			$('#theoutput').prop("class", "alert alert-success");
			$('#theoutput').text("valid");
		} else if (res == "false") {
			$('#theoutput').prop("class", "alert alert-warning");
			$('#theoutput').text("invalid");
		} else {
			$('#theoutput').prop("class", "alert alert-danger");
			$('#theoutput').text(res);
		}
	}
}

function reportError(err) {
	$('#theoutput').prop("class", "alert alert-danger");
	$('#theoutput').text(err);
}

function saveCode(katydidCodeMirror, jsonCodeMirror) {
	var katydidcode = katydidCodeMirror.getValue();
	var jsoncode = jsonCodeMirror.getValue();
	var github = new Github({});
	var gist = github.getGist();
	gist.create({
        "description": "saved katydid src",
        "public": true,
        "files": {
            "katydidsrc": {
            	"content": katydidcode,
            },
            "jsonsrc": {
            	"content": jsoncode,
            }
        }
    }, function(err, rest) {
    	if (err == undefined) {
    		window.location.assign("./index.html?gist="+rest.id+"&share=true");
    	} else {
    		reportError(err);
    	}
    });
}

function loadCode(katydidCodeMirror, jsonCodeMirror) {
	var github = new Github({});
	var gist = github.getGist(gistText);
	gist.read(function(err, content) {
		if (err == undefined) {
			katydidCodeMirror.setValue(content.files["katydidsrc"].content);
			jsonCodeMirror.setValue(content.files["jsonsrc"].content);
		} else {
			reportError(err);
		}
	});
}

function displayShareBox() {
	var linkText = window.location.href.replace("&share=true", "");
	$("#thelink").val(linkText);
	$("#thelink").prop("hidden", false);
	var theLinkBox = document.getElementById("thelink");
    theLinkBox.onfocus = function() {
        theLinkBox.select();

        // Work around Chrome's little problem
        theLinkBox.onmouseup = function() {
            // Prevent further mouseup intervention
            theLinkBox.onmouseup = null;
            return false;
        };
    };
    theLinkBox.focus();
}

CodeMirror.defineSimpleMode("katydidmode", {
	start: [
		{regex: /"(?:[^\\]|\\.)*?"/, token: "string"},
		{regex: /(?:\<emptyset\>|\<empty\>)/,
     	token: "keyword"},
     	{regex: /\/\/.*/, token: "comment"},
     	{regex: /\/\*/, token: "comment", next: "comment"}
	],
	comment: [
    	{regex: /.*?\*\//, token: "comment", next: "start"},
    	{regex: /.*/, token: "comment"}
  	]
});

function init() {
	gistText = getUrlParameter("gist");
	share = getUrlParameter("share");
	var katydidCodeMirror = CodeMirror(document.getElementById("lefttextarea"), {
  		mode:  "katydidmode",
  		value: 'loading...'
	});
	var jsonCodeMirror = CodeMirror(document.getElementById("righttextarea"), {
  		mode:  {name: "javascript", json: true},
  		value: 'loading...'
	});
	if (gistText == undefined) {
		defaultKatydid = 'WhatsUp == "E"';
		katydidCodeMirror.setValue(defaultKatydid);
		jsonDefault = '{\n\
	"WhatsUp": "E"\n\
}';
		jsonCodeMirror.setValue(jsonDefault);
	} else {
		loadCode(katydidCodeMirror, jsonCodeMirror);
		if (!(share == undefined)) {
			displayShareBox();
	    }
	}

	$("#saveButton").click(function(ev) { 
		saveCode(katydidCodeMirror, jsonCodeMirror);
	});

	$("#validateButton").click(function(ev) { 
		ev.preventDefault();
		validateCode(katydidCodeMirror, jsonCodeMirror);
	});

	katydidCodeMirror.on('keyup', function(instance, event) {
    	validateCode(katydidCodeMirror, jsonCodeMirror);
	});
	
	jsonCodeMirror.on('keyup', function(instance, event) {
    	validateCode(katydidCodeMirror, jsonCodeMirror);
	});

}

</script>

</head>
<body>
<a href="https://github.com/katydid/katydid"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/121cd7cbdc3e4855075ea8b558508b91ac463ac2/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png"></a>
<div class="row">
	<div class="col-xs-1"></div>
	<div class="col-xs-10 pull-down">
		<textarea class="col-xs-12" rows="1" autofocus="true" spellcheck="false" id="thelink" readonly="true" hidden></textarea>
	</div>
	<div class="col-xs-1">
		<a href="#" id="saveButton" class="btn btn-primary pull-right" role="button">Share</a>
	</div>
</div>
<div class="row">
	<div class="col-xs-12"><h2 class="text-center">Katydid Playground</h2></div>
</div>
<p></p>
<div class="row">
	<div class="col-xs-5">
		<div class="row">
			<div class="col-xs-2"></div>
			<div class="col-xs-10">
				<h3>Validator</h3>	
			</div>
		</div>
	</div>
	<div class="col-xs-2"></div>
	<div class="col-xs-5">
		<div class="row">
			<div class="col-xs-10">
				<h3>Json Input</h3>	
			</div>
			<div class="col-xs-2"></div>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-xs-5">
		<div class="row">
			<div class="col-xs-2"></div>
			<div class="col-xs-10">
				<div id="lefttextarea"></div>
			</div>
		</div>
	</div>
	<div class="col-xs-2 text-center">
		<a href="#" id="validateButton" class="btn btn-success" role="button">Validate</a>
	</div>
	<div class="col-xs-5">
		<div class="row">
			<div class="col-xs-10">
				<div id="righttextarea"></div>
			</div>
			<div class="col-xs-2"></div>
		</div>
	</div>
</div>
<p></p>
<p></p>
<div class="row">
	<div class="col-xs-1"></div>
	<div class="col-xs-10 text-center">
	<div id="theoutput"></div>
	</div>
	<div class="col-xs-1"></div>
</div>
<div class="row">
	<div class="col-xs-1"></div>
	<div class="col-xs-10">
	<div class="panel panel-default">
  		<div class="panel-heading text-center">
    		<h3 class="panel-title">Quick Reference</h3>
  		</div>
  		<div class="panel-body">
    		<div class="row">
				<div class="col-xs-6">
					<div class="row">
						<div class="col-xs-4">v != true</div>
						<div class="col-xs-8">Field v is a boolean which is false</div>
					</div>
					<div class="row">
						<div class="col-xs-4">D *= "bc"</div>
						<div class="col-xs-8">D is a string which contains the substring bc</div>
					</div>
					<div class="row">
						<div class="col-xs-4">"num" &lt; int(-100)</div>
						<div class="col-xs-8">num is an int which is less than negative 100</div>
					</div>
					<div class="row">
						<div class="col-xs-4">"t\"" &gt;= uint(100)</div>
						<div class="col-xs-8">t" is an unsigned int which is greater than or equal to a 100</div>
					</div>
					<div class="row">
						<div class="col-xs-4">`F\ g h` &gt; double(0.5)</div>
						<div class="col-xs-8">F\ g h is a floating point number which is greater than a half</div>
					</div>
					<div class="row">
						<div class="col-xs-4">B == []byte{0xfe,'a',255}</div>
						<div class="col-xs-8">B is an array of bytes which equals {254,97,255}. note: json has no bytes type.</div>
					</div>
					<div class="row">
						<div class="col-xs-4">a ^= "abc"</div>
						<div class="col-xs-8">... starts with abc</div>
					</div>
					<div class="row">
						<div class="col-xs-4">a $= "xyz"</div>
						<div class="col-xs-8">... ends with xyz</div>
					</div>
					<div class="row">
						<div class="col-xs-4">a ~= "^abc.*xyz$"</div>
						<div class="col-xs-8">... matches the regular expression, which means it starts with abc and ends with xyz</div>
					</div>
					<div class="row">
						<div class="col-xs-4">D -&gt; contains($string, "bc")</div>
						<div class="col-xs-8">D is a string which contains the substring bc</div>
					</div>
					<div class="row">
						<div class="col-xs-4">L-&gt;gt(length($[]byte), int(0))</div>
						<div class="col-xs-8">L is an array of bytes which has a length greater than zero</div>
					</div>
					<div class="row">
						<div class="col-xs-4">N-&gt;and(ge($int, int(10)), lt($int, int(20)))</div>
						<div class="col-xs-8">N is an int which is greater than or equal to 10 and less than 20</div>
					</div>
				</div>
				<div class="col-xs-6">
					<div class="row">
						<div class="col-xs-4">*</div>
						<div class="col-xs-8">The structure contains zero or more of anything</div>
					</div>
					<div class="row">
						<div class="col-xs-4">A: *</div>
						<div class="col-xs-8">The structure contains one field named A, which contains anything</div>
					</div>
					<div class="row">
						<div class="col-xs-4">A: b == "c"</div>
						<div class="col-xs-8">The structure contains one field named A, which contains one field named b, which equals c</div>
					</div>
					<div class="row">
						<div class="col-xs-4">[A:*,B:*]</div>
						<div class="col-xs-8">... two fields, A followed by B.  Each of these fields can contain anything</div>
					</div>
					<div class="row">
						<div class="col-xs-4">C [A:*,B:*]</div>
						<div class="col-xs-8">... one field C which contains two fields, A followed by B ...</div>
					</div>
					<div class="row">
						<div class="col-xs-4">(A:*|B:*|C:*)</div>
						<div class="col-xs-8">... one field: A, B or C.</div>
					</div>
					<div class="row">
						<div class="col-xs-4">_:*</div>
						<div class="col-xs-8">one field, which has any name and contains anything</div>
					</div>
					<div class="row">
						<div class="col-xs-4">(A|B):*</div>
						<div class="col-xs-8">one field named A or B</div>
					</div>
					<div class="row">
						<div class="col-xs-4">!(A):*</div>
						<div class="col-xs-8">one field named anything except A</div>
					</div>
					<div class="row">
						<div class="col-xs-4">((A|B):*&amp;(A|C):*)</div>
						<div class="col-xs-8">one field named A</div>
					</div>
					<div class="row">
						<div class="col-xs-4">(A:*)*</div>
						<div class="col-xs-8">zero or more fields named A, which each contains anything</div>
					</div>
					<div class="row">
						<div class="col-xs-4">!(A:*)</div>
						<div class="col-xs-8">any structure that does have just one field named A</div>
					</div>
					<div class="row">
						<div class="col-xs-4">A:#myref @myref=b=="c"</div>
						<div class="col-xs-8">The structure contains one field named A, which contains one field named b, which equals c.</div>
					</div>
					<div class="row">
						<div class="col-xs-4">@main=A:(#main|b=="c")</div>
						<div class="col-xs-8">one field A containing one field A ... where one eventually contains a field b which equals c</div>
					</div>
					<div class="row">
						<div class="col-xs-4">.A:*</div>
						<div class="col-xs-8">equivalent to [*,A:*,*]. 
						A structure which contains a field A.</div>
					</div>
					<div class="row">
						<div class="col-xs-4">.A.b=="c"</div>
						<div class="col-xs-8">equivalent to [*,A:[*,b==c,*],*].  
						A structure which contains a field A, which contains a field b which is equal to c</div>
					</div>
					<div class="row">
						<div class="col-xs-4">{A:*|B:*}</div>
						<div class="col-xs-8">equivalent to ([*,A:*,*]|[*,B:*,*]).
						A structure which contains a field A or B and any other fields</div>
					</div>
					<div class="row">
						<div class="col-xs-4">{A:*&amp;B:*}</div>
						<div class="col-xs-8">equivalent to ([*,A:*,*]&amp;[*,B:*,*])
						A structure which contains at least a field A and B, but may also contain other extra fields</div>
					</div>
				</div>
			</div>
  		</div>
  		<div class="panel-footer">
  			<div class="row">
  				<div class="col-xs-4 text-center">
  					field types: $double, $int, $uint, $bool, $string, $[]byte
  				</div>
  				<div class="col-xs-4 text-center">
  					<a href="https://github.com/katydid/katydid/blob/master/list_of_functions.txt">list of other functions</a>
  				</div>
  				<div class="col-xs-4 text-center">
  					<a href="https://github.com/katydid/katydid/blob/prototype/relapse/all.bnf">grammar specification</a>
  				</div>
  			</div>
  		</div>
	</div>
	</div>
	<div class="col-xs-1"></div>
</div>

</body>

<script type="text/javascript">
	init();
</script>

<style type="text/css">
	/* Copied this style from http://stackoverflow.com/questions/12742058/apply-twitter-bootstrap-stylings-to-codemirror */
	.CodeMirror {
      line-height: 1.3em;
      font-family: monospace;

      /* Necessary so the scrollbar can be absolutely positioned within the wrapper on Lion. */
      position: relative;
      /* This prevents unwanted scrollbars from showing up on the body and wrapper in IE. */
      overflow: hidden;
      background-color: white;
      width: 100%;

      /* Copied from Bootstrap's textarea */
      display: inline-block;
      padding: 4px 6px;
      margin-bottom: 9px;
      color: #555555;
      border: 1px solid #ccc;
      -webkit-border-radius: 3px;
      -moz-border-radius: 3px;
      border-radius: 3px;
      -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
      -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
      box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
      -webkit-transition: border linear 0.2s, box-shadow linear 0.2s;
      -moz-transition: border linear 0.2s, box-shadow linear 0.2s;
      -ms-transition: border linear 0.2s, box-shadow linear 0.2s;
      -o-transition: border linear 0.2s, box-shadow linear 0.2s;
      transition: border linear 0.2s, box-shadow linear 0.2s;  
    }

    .CodeMirror-focused {
      /* Copied from Bootstrap's textarea */
      border-color: rgba(82, 168, 236, 0.8);
      outline: 0;
      outline: thin dotted \9;
      /* IE6-9 */

      -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);
         -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);
              box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);  
    }

</style>

<script type="text/javascript">
	$('.pull-down').each(function() {
    $(this).css('margin-top', $(this).parent().height()-$(this).height())
});
</script>

</html>